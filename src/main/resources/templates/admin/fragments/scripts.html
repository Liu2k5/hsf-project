<!DOCTYPE html>
<html lang="vi" xmlns:th="https://www.thymeleaf.org">
<body>
<script th:fragment="scripts">
    // Global state
    let currentUsersPage = 0;
    let currentOrdersPage = 0;
    let currentLicensesPage = 0;
    let selectedUserId = null;
    let selectedLicenseKey = null;
    let searchTimeout = null;

    // Tab switching
    function switchTab(tabName, event) {
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');

        // Load data when switching tabs
        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadUsers(0);
        else if (tabName === 'orders') loadOrders(0);
        else if (tabName === 'licenses') loadLicenses(0);
    }

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // Format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load Dashboard
    async function loadDashboard() {
        try {
            // Load summary stats
            const statsResponse = await fetch('/admin/stats/summary');
            if (!statsResponse.ok) throw new Error('Failed to load stats');
            const stats = await statsResponse.json();

            document.getElementById('total-revenue').textContent = formatCurrency(stats.totalRevenue || 0);
            document.getElementById('new-orders-today').textContent = stats.newOrdersToday || 0;
            document.getElementById('active-sessions').textContent = stats.activeSessions || 0;

            // Load top products
            const productsResponse = await fetch('/admin/stats/top-products');
            if (!productsResponse.ok) throw new Error('Failed to load products');
            const products = await productsResponse.json();

            const productsList = document.getElementById('top-products');
            if (products.length === 0) {
                productsList.innerHTML = '<li>Ch∆∞a c√≥ d·ªØ li·ªáu</li>';
            } else {
                productsList.innerHTML = products.map(p => `
                        <li>
                            <span class="product-name">${escapeHtml(p.productName)}</span>
                            <span class="product-count">${p.salesCount} ƒë∆°n</span>
                        </li>
                    `).join('');
            }

            // Load revenue chart (simplified - in production use Chart.js)
            const revenueResponse = await fetch('/admin/stats/revenue-chart');
            if (!revenueResponse.ok) throw new Error('Failed to load revenue data');
            const revenueData = await revenueResponse.json();

            // Note: This is a placeholder. In production, use Chart.js or similar library
            const canvas = document.getElementById('revenue-chart');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = 300;

            if (revenueData.length > 0) {
                drawSimpleChart(ctx, revenueData, canvas.width, canvas.height);
            } else {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu', canvas.width / 2, canvas.height / 2);
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Simple chart drawing (replace with Chart.js in production)
    function drawSimpleChart(ctx, data, width, height) {
        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        const maxRevenue = Math.max(...data.map(d => d.revenue));
        const xStep = chartWidth / (data.length - 1 || 1);

        ctx.clearRect(0, 0, width, height);

        // Draw axes
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();

        // Draw line
        ctx.strokeStyle = '#3498db';
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = height - padding - (point.revenue / maxRevenue) * chartHeight;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });

        ctx.stroke();

        // Draw points
        ctx.fillStyle = '#3498db';
        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = height - padding - (point.revenue / maxRevenue) * chartHeight;

            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // Load Users
    async function loadUsers(page) {
        currentUsersPage = page;
        try {
            const response = await fetch(`/admin/users?page=${page}&size=10`);
            if (!response.ok) throw new Error('Failed to load users');
            const data = await response.json();

            const tbody = document.getElementById('users-table');
            if (data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(user => {
                    const escapedUsername = escapeHtml(user.username);
                    const escapedRole = escapeHtml(user.roleName);
                    return `
                        <tr>
                            <td>${user.userId}</td>
                            <td>${escapedUsername}</td>
                            <td><span class="badge badge-info">${escapedRole}</span></td>
                            <td>
                                <span class="badge ${user.locked ? 'badge-danger' : 'badge-success'}">
                                    ${user.locked ? 'üîí Kh√≥a' : '‚úì Ho·∫°t ƒë·ªông'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick='openUpdateRole(${user.userId}, ${JSON.stringify(escapedUsername)}, ${JSON.stringify(escapedRole)})'>
                                    ƒê·ªïi vai tr√≤
                                </button>
                                <button class="btn ${user.locked ? 'btn-success' : 'btn-warning'} btn-sm"
                                        onclick="toggleLock(${user.userId}, ${!user.locked})">
                                    ${user.locked ? 'M·ªü kh√≥a' : 'Kh√≥a'}
                                </button>
                            </td>
                        </tr>
                    `;}).join('');
            }

            renderPagination('users-pagination', data.totalPages, page, loadUsers);
        } catch (error) {
            console.error('Error loading users:', error);
            showError('users-error', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng');
        }
    }

    // Load Orders
    async function loadOrders(page) {
        currentOrdersPage = page;
        try {
            const status = document.getElementById('order-status-filter').value;
            const date = document.getElementById('order-date-filter').value;

            let url = `/admin/orders?page=${page}&size=10`;
            if (status) url += `&status=${encodeURIComponent(status)}`;
            if (date) url += `&startDate=${encodeURIComponent(date)}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load orders');
            const data = await response.json();

            const tbody = document.getElementById('orders-table');
            if (data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(order => `
                        <tr>
                            <td>${order.orderId}</td>
                            <td>${escapeHtml(order.username)}</td>
                            <td>${escapeHtml(order.productName)}</td>
                            <td>${order.paidDate || 'N/A'}</td>
                            <td>
                                <span class="badge ${getStatusBadge(order.status)}">
                                    ${getStatusText(order.status)}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewOrderDetails(${order.orderId})">
                                    Chi ti·∫øt
                                </button>
                            </td>
                        </tr>
                    `).join('');
            }

            renderPagination('orders-pagination', data.totalPages, page, loadOrders);
        } catch (error) {
            console.error('Error loading orders:', error);
            showError('orders-error', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng');
        }
    }

    // Load Licenses
    async function loadLicenses(page, searchKey = '') {
        currentLicensesPage = page;
        try {
            let url = `/admin/licenses?page=${page}&size=10`;
            if (searchKey) url += `&searchKey=${encodeURIComponent(searchKey)}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load licenses');
            const data = await response.json();

            const tbody = document.getElementById('licenses-table');
            if (data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(license => {
                    const escapedKey = escapeHtml(license.licenseKey);
                    const escapedUsername = escapeHtml(license.username);
                    const escapedProduct = escapeHtml(license.productName);
                    return `
                        <tr>
                            <td>${license.licenseId}</td>
                            <td><code>${escapedKey}</code></td>
                            <td>${escapedUsername}</td>
                            <td>${escapedProduct}</td>
                            <td>
                                <span class="badge ${license.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${license.enabled ? '‚úì Ho·∫°t ƒë·ªông' : '‚úó B·ªã thu h·ªìi'}
                                </span>
                            </td>
                            <td>
                                ${license.enabled ? `
                                    <button class="btn btn-danger btn-sm" onclick='openRevoke(${JSON.stringify(escapedKey)})'>
                                        Thu h·ªìi
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick='resetDevice(${JSON.stringify(escapedKey)})'>
                                        Reset thi·∫øt b·ªã
                                    </button>
                                ` : '<span style="color: #999;">ƒê√£ thu h·ªìi</span>'}
                            </td>
                        </tr>
                    `;}).join('');
            }

            renderPagination('licenses-pagination', data.totalPages, page, (p) => loadLicenses(p, searchKey));
        } catch (error) {
            console.error('Error loading licenses:', error);
            showError('licenses-error', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu gi·∫•y ph√©p');
        }
    }

    // Search licenses with debounce
    function searchLicenses() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchKey = document.getElementById('license-search').value;
            loadLicenses(0, searchKey);
        }, 500);
    }

    // Helper functions
    function getStatusBadge(status) {
        const badges = {
            'PENDING': 'badge-warning',
            'COMPLETED': 'badge-success',
            'CANCELLED': 'badge-danger'
        };
        return badges[status] || 'badge-info';
    }

    function getStatusText(status) {
        const texts = {
            'PENDING': 'ƒêang ch·ªù',
            'COMPLETED': 'Ho√†n th√†nh',
            'CANCELLED': 'ƒê√£ h·ªßy'
        };
        return texts[status] || status;
    }

    function renderPagination(containerId, totalPages, currentPage, loadFunction) {
        const container = document.getElementById(containerId);
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        // Create pagination buttons programmatically instead of using function.name
        container.innerHTML = '';

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '‚Üê Tr∆∞·ªõc';
        prevBtn.disabled = currentPage === 0;
        if (currentPage > 0) {
            prevBtn.addEventListener('click', () => loadFunction(currentPage - 1));
        }
        container.appendChild(prevBtn);

        // Page number buttons
        const start = Math.max(0, currentPage - 2);
        const end = Math.min(totalPages, currentPage + 3);

        for (let i = start; i < end; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i + 1;
            if (i === currentPage) {
                pageBtn.className = 'active';
            }
            pageBtn.addEventListener('click', () => loadFunction(i));
            container.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Sau ‚Üí';
        nextBtn.disabled = currentPage >= totalPages - 1;
        if (currentPage < totalPages - 1) {
            nextBtn.addEventListener('click', () => loadFunction(currentPage + 1));
        }
        container.appendChild(nextBtn);
    }

    function showError(elementId, message) {
        const errorDiv = document.getElementById(elementId);
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // User management functions
    function openUpdateRole(userId, username, currentRole) {
        selectedUserId = userId;
        document.getElementById('role-username').value = username;
        document.getElementById('role-select').value = currentRole;
        openModal('role-modal');
    }

    async function updateRole() {
        const newRole = document.getElementById('role-select').value;
        try {
            const response = await fetch('/admin/users/role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: selectedUserId,
                    newRoleName: newRole
                })
            });

            if (response.ok) {
                closeModal('role-modal');
                loadUsers(currentUsersPage);
                alert('C·∫≠p nh·∫≠t vai tr√≤ th√†nh c√¥ng!');
            } else {
                alert('L·ªói: Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤');
            }
        } catch (error) {
            console.error('Error updating role:', error);
            alert('L·ªói: Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤');
        }
    }

    async function toggleLock(userId, lock) {
        const action = lock ? 'kh√≥a' : 'm·ªü kh√≥a';
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} t√†i kho·∫£n n√†y?`)) return;

        try {
            const response = await fetch('/admin/users/lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, lock })
            });

            if (response.ok) {
                loadUsers(currentUsersPage);
                alert(`${action.charAt(0).toUpperCase() + action.slice(1)} t√†i kho·∫£n th√†nh c√¥ng!`);
            } else {
                alert(`L·ªói: Kh√¥ng th·ªÉ ${action} t√†i kho·∫£n`);
            }
        } catch (error) {
            console.error('Error toggling lock:', error);
            alert(`L·ªói: Kh√¥ng th·ªÉ ${action} t√†i kho·∫£n`);
        }
    }

    // Order management functions
    async function viewOrderDetails(orderId) {
        openModal('order-modal');
        document.getElementById('order-details').innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';

        try {
            const response = await fetch(`/admin/orders/${orderId}`);
            if (!response.ok) throw new Error('Failed to load order details');
            const order = await response.json();

            const detailsDiv = document.getElementById('order-details');
            detailsDiv.innerHTML = '';

            // Create elements programmatically for safety
            const fields = [
                { label: 'M√£ ƒë∆°n h√†ng:', value: order.orderId },
                { label: 'Ng∆∞·ªùi d√πng:', value: order.username },
                { label: 'S·∫£n ph·∫©m:', value: order.productName },
                { label: 'Ng√†y thanh to√°n:', value: order.paidDate || 'Ch∆∞a thanh to√°n' }
            ];

            fields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'form-group';
                const label = document.createElement('label');
                label.textContent = field.label;
                const value = document.createElement('div');
                value.textContent = field.value;
                group.appendChild(label);
                group.appendChild(value);
                detailsDiv.appendChild(group);
            });

            // Status field with badge
            const statusGroup = document.createElement('div');
            statusGroup.className = 'form-group';
            const statusLabel = document.createElement('label');
            statusLabel.textContent = 'Tr·∫°ng th√°i:';
            const statusValue = document.createElement('div');
            statusValue.innerHTML = `<span class="badge ${getStatusBadge(order.status)}">${getStatusText(order.status)}</span>`;
            statusGroup.appendChild(statusLabel);
            statusGroup.appendChild(statusValue);
            detailsDiv.appendChild(statusGroup);

            // License info if exists
            if (order.license) {
                const licenseGroup = document.createElement('div');
                licenseGroup.className = 'form-group';
                const licenseLabel = document.createElement('label');
                licenseLabel.textContent = 'Gi·∫•y ph√©p:';
                const licenseValue = document.createElement('div');

                const keyDiv = document.createElement('div');
                const keyStrong = document.createElement('strong');
                keyStrong.textContent = 'Key: ';
                const keyCode = document.createElement('code');
                keyCode.textContent = order.license.licenseKey;
                keyDiv.appendChild(keyStrong);
                keyDiv.appendChild(keyCode);

                const statusDiv = document.createElement('div');
                const statusStrong = document.createElement('strong');
                statusStrong.textContent = 'Tr·∫°ng th√°i: ';
                statusDiv.appendChild(statusStrong);
                statusDiv.innerHTML += `<span class="badge ${order.license.enabled ? 'badge-success' : 'badge-danger'}">
                        ${order.license.enabled ? 'Ho·∫°t ƒë·ªông' : 'B·ªã thu h·ªìi'}
                    </span>`;

                licenseValue.appendChild(keyDiv);
                licenseValue.appendChild(statusDiv);
                licenseGroup.appendChild(licenseLabel);
                licenseGroup.appendChild(licenseValue);
                detailsDiv.appendChild(licenseGroup);
            } else {
                const noLicenseGroup = document.createElement('div');
                noLicenseGroup.className = 'form-group';
                const em = document.createElement('em');
                em.textContent = 'Ch∆∞a c√≥ gi·∫•y ph√©p';
                noLicenseGroup.appendChild(em);
                detailsDiv.appendChild(noLicenseGroup);
            }
        } catch (error) {
            console.error('Error loading order details:', error);
            document.getElementById('order-details').innerHTML = '<div class="error">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng</div>';
        }
    }

    // License management functions
    function openRevoke(licenseKey) {
        selectedLicenseKey = licenseKey;
        document.getElementById('revoke-key').value = licenseKey;
        document.getElementById('revoke-reason').value = '';
        openModal('revoke-modal');
    }

    async function revokeLicense() {
        const reason = document.getElementById('revoke-reason').value;
        if (!reason.trim()) {
            alert('Vui l√≤ng nh·∫≠p l√Ω do thu h·ªìi');
            return;
        }

        try {
            const response = await fetch('/admin/licenses/revoke', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    licenseKey: selectedLicenseKey,
                    reason: reason
                })
            });

            if (response.ok) {
                closeModal('revoke-modal');
                loadLicenses(currentLicensesPage, document.getElementById('license-search').value);
                alert('Thu h·ªìi gi·∫•y ph√©p th√†nh c√¥ng!');
            } else {
                alert('L·ªói: Kh√¥ng th·ªÉ thu h·ªìi gi·∫•y ph√©p');
            }
        } catch (error) {
            console.error('Error revoking license:', error);
            alert('L·ªói: Kh√¥ng th·ªÉ thu h·ªìi gi·∫•y ph√©p');
        }
    }

    async function resetDevice(licenseKey) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset thi·∫øt b·ªã cho gi·∫•y ph√©p n√†y?')) return;

        try {
            const response = await fetch('/admin/licenses/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ licenseKey })
            });

            if (response.ok) {
                alert('Reset thi·∫øt b·ªã th√†nh c√¥ng!');
            } else {
                alert('L·ªói: Kh√¥ng th·ªÉ reset thi·∫øt b·ªã');
            }
        } catch (error) {
            console.error('Error resetting device:', error);
            alert('L·ªói: Kh√¥ng th·ªÉ reset thi·∫øt b·ªã');
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboard();
    });
</script>
</body>
</html>