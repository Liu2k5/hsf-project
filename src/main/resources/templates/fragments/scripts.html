<script th:fragment="scripts">
    /* admin scripts fragment
       - Persist selected tab across reloads using location.hash + localStorage
       - Robust switchTab that works when called with/without event and when event.target is inner element
       - Binds nav buttons (keeps compatibility with inline onclick)
       - Initializes page according to hash/localStorage or fallback to server-rendered active button
    */

    'use strict';

    // Global state
    let currentUsersPage = 0;
    let currentOrdersPage = 0;
    let currentLicensesPage = 0;
    let selectedUserId = null;
    let selectedLicenseKey = null;
    let searchTimeout = null;

    // Tab switching (robust)
    function switchTab(tabName, event) {
        // remove previous active classes
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // find the button to mark active:
        let btn = null;
        if (event) {
            // prefer currentTarget, fall back to target.closest
            btn = event.currentTarget || (event.target && event.target.closest && event.target.closest('.nav-tab'));
        }
        if (!btn) {
            // prefer data-tab attribute
            btn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        }
        if (!btn) {
            // fallback: try to find button that has onclick calling switchTab with the tabName
            const candidates = Array.from(document.querySelectorAll('.nav-tab'));
            for (const c of candidates) {
                const onclick = c.getAttribute && c.getAttribute('onclick');
                if (onclick && onclick.indexOf(`'${tabName}'`) !== -1) {
                    btn = c;
                    break;
                }
            }
        }
        if (btn) btn.classList.add('active');

        // show the content
        const content = document.getElementById(tabName + '-tab');
        if (content) content.classList.add('active');

        // persist selected tab: set hash and localStorage (history.replaceState avoids extra history entry)
        try {
            history.replaceState(null, '', '#' + tabName);
        } catch (e) {
            try { location.hash = tabName; } catch (e2) { /* ignore */ }
        }
        try {
            localStorage.setItem('activeAdminTab', tabName);
        } catch (e) {
            // ignore storage errors (private mode)
        }

        // Load data when switching tabs
        if (tabName === 'dashboard') loadDashboard();
        else if (tabName === 'users') loadUsers(0);
        else if (tabName === 'orders') loadOrders(0);
        else if (tabName === 'licenses') loadLicenses(0);
        else if (tabName === 'products') loadProducts();
    }

    // Modal functions
    function openModal(modalId) {
        const el = document.getElementById(modalId);
        if (el) el.classList.add('active');
    }

    function closeModal(modalId) {
        const el = document.getElementById(modalId);
        if (el) el.classList.remove('active');
    }

    // Format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Load Dashboard
    async function loadDashboard() {
        try {
            // Load summary stats
            const statsResponse = await fetch('/admin/stats/summary');
            if (!statsResponse.ok) throw new Error('Failed to load stats');
            const stats = await statsResponse.json();

            const totalRevenueEl = document.getElementById('total-revenue');
            const newOrdersEl = document.getElementById('new-orders-today');
            const activeSessionsEl = document.getElementById('active-sessions');

            if (totalRevenueEl) totalRevenueEl.textContent = formatCurrency(stats.totalRevenue || 0);
            if (newOrdersEl) newOrdersEl.textContent = stats.newOrdersToday || 0;
            if (activeSessionsEl) activeSessionsEl.textContent = stats.activeSessions || 0;

            // Load top products
            const productsResponse = await fetch('/admin/stats/top-products');
            if (!productsResponse.ok) throw new Error('Failed to load products');
            const products = await productsResponse.json();

            const productsList = document.getElementById('top-products');
            if (productsList) {
                if (!Array.isArray(products) || products.length === 0) {
                    productsList.innerHTML = '<li>Chưa có dữ liệu</li>';
                } else {
                    productsList.innerHTML = products.map(p => `
                    <li>
                        <span class="product-name">${escapeHtml(p.productName)}</span>
                        <span class="product-count">${p.salesCount} đơn</span>
                    </li>
                `).join('');
                }
            }

            // Load revenue chart
            const revenueResponse = await fetch('/admin/stats/revenue-chart');
            if (!revenueResponse.ok) throw new Error('Failed to load revenue data');
            const revenueData = await revenueResponse.json();

            const canvas = document.getElementById('revenue-chart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.parentElement.clientWidth || 600;
                canvas.height = 300;

                if (Array.isArray(revenueData) && revenueData.length > 0) {
                    drawSimpleChart(ctx, revenueData, canvas.width, canvas.height);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';
                    ctx.fillText('Chưa có dữ liệu doanh thu', canvas.width / 2, canvas.height / 2);
                }
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Simple chart drawing (replace with Chart.js in production)
    function drawSimpleChart(ctx, data, width, height) {
        const padding = 40;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        const maxRevenue = Math.max(...data.map(d => d.revenue), 1);
        const xStep = chartWidth / (data.length - 1 || 1);

        ctx.clearRect(0, 0, width, height);

        // Draw axes
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();

        // Draw line
        ctx.strokeStyle = '#3498db';
        ctx.lineWidth = 2;
        ctx.beginPath();

        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = height - padding - (point.revenue / maxRevenue) * chartHeight;

            if (index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });

        ctx.stroke();

        // Draw points
        ctx.fillStyle = '#3498db';
        data.forEach((point, index) => {
            const x = padding + index * xStep;
            const y = height - padding - (point.revenue / maxRevenue) * chartHeight;

            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // Load Users
    async function loadUsers(page) {
        currentUsersPage = page;
        console.log('loadUsers called for page:', page);
        try {
            const response = await fetch(`/admin/users?page=${page}&size=10`);
            if (!response.ok) throw new Error('Failed to load users');
            const data = await response.json();
            console.log('Users data received:', data);

            const tbody = document.getElementById('users-table');
            if (!tbody) return;

            if (!data || !Array.isArray(data.content) || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Không có dữ liệu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(user => {
                    const escapedUsername = escapeHtml(user.username);
                    const escapedRole = escapeHtml(user.roleName);
                    const isAdmin = escapedRole === 'ROLE_ADMIN';
                    return `
                <tr>
                    <td>${user.userId}</td>
                    <td>${escapedUsername}</td>
                    <td><span class="badge badge-info">${escapedRole}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick='openUpdateRole(${user.userId}, ${JSON.stringify(escapedUsername)}, ${JSON.stringify(escapedRole)})'>
                            Đổi vai trò
                        </button>
                        ${!isAdmin ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.userId})">
                            Xóa
                        </button>
                        ` : '<span style="color: #999;">Admin không thể xóa</span>'}
                    </td>
                </tr>
            `;}).join('');
            }

            renderPagination('users-pagination', data.totalPages, page, loadUsers);
        } catch (error) {
            console.error('Error loading users:', error);
            showError('users-error', 'Không thể tải dữ liệu người dùng');
        }
    }

    // Load Orders
    async function loadOrders(page) {
        currentOrdersPage = page;
        try {
            const statusEl = document.getElementById('order-status-filter');
            const dateEl = document.getElementById('order-date-filter');
            const status = statusEl ? statusEl.value : '';
            const date = dateEl ? dateEl.value : '';

            let url = `/admin/orders?page=${page}&size=10`;
            if (status) url += `&status=${encodeURIComponent(status)}`;
            if (date) url += `&startDate=${encodeURIComponent(date)}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load orders');
            const data = await response.json();

            const tbody = document.getElementById('orders-table');
            if (!tbody) return;

            if (!data || !Array.isArray(data.content) || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(order => `
                <tr>
                    <td>${order.orderId}</td>
                    <td>${escapeHtml(order.username)}</td>
                    <td>${escapeHtml(order.productName)}</td>
                    <td>${order.paidDate || 'N/A'}</td>
                    <td>
                        <span class="badge ${getStatusBadge(order.status)}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewOrderDetails(${order.orderId})">
                            Chi tiết
                        </button>
                    </td>
                </tr>
            `).join('');
            }

            renderPagination('orders-pagination', data.totalPages, page, loadOrders);
        } catch (error) {
            console.error('Error loading orders:', error);
            showError('orders-error', 'Không thể tải dữ liệu đơn hàng');
        }
    }

    // Load Licenses
    async function loadLicenses(page, searchKey = '') {
        currentLicensesPage = page;
        try {
            let url = `/admin/licenses?page=${page}&size=10`;
            if (searchKey) url += `&searchKey=${encodeURIComponent(searchKey)}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load licenses');
            const data = await response.json();

            const tbody = document.getElementById('licenses-table');
            if (!tbody) return;

            if (!data || !Array.isArray(data.content) || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Không có dữ liệu</td></tr>';
            } else {
                tbody.innerHTML = data.content.map(license => {
                    const escapedKey = escapeHtml(license.licenseKey);
                    const escapedUsername = escapeHtml(license.username);
                    const escapedProduct = escapeHtml(license.productName);
                    return `
                <tr>
                    <td>${license.licenseId}</td>
                    <td><code>${escapedKey}</code></td>
                    <td>${escapedUsername}</td>
                    <td>${escapedProduct}</td>
                    <td>
                        <span class="badge ${license.enabled ? 'badge-success' : 'badge-danger'}">
                            ${license.enabled ? '✓ Hoạt động' : '✗ Bị thu hồi'}
                        </span>
                    </td>
                    <td>
                        ${license.enabled ? `
                            <button class="btn btn-danger btn-sm" onclick='openRevoke(${JSON.stringify(escapedKey)})'>
                                Thu hồi
                            </button>
                            <button class="btn btn-warning btn-sm" onclick='resetDevice(${JSON.stringify(escapedKey)})'>
                                Reset thiết bị
                            </button>
                        ` : '<span style="color: #999;">Đã thu hồi</span>'}
                    </td>
                </tr>
            `;}).join('');
            }

            renderPagination('licenses-pagination', data.totalPages, page, (p) => loadLicenses(p, searchKey));
        } catch (error) {
            console.error('Error loading licenses:', error);
            showError('licenses-error', 'Không thể tải dữ liệu giấy phép');
        }
    }

    // Search licenses with debounce
    function searchLicenses() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchKeyEl = document.getElementById('license-search');
            const searchKey = searchKeyEl ? searchKeyEl.value : '';
            loadLicenses(0, searchKey);
        }, 500);
    }

    // Helper functions
    function getStatusBadge(status) {
        const badges = {
            'PENDING': 'badge-warning',
            'COMPLETED': 'badge-success',
            'CANCELLED': 'badge-danger'
        };
        return badges[status] || 'badge-info';
    }

    function getStatusText(status) {
        const texts = {
            'PENDING': 'Đang chờ',
            'COMPLETED': 'Hoàn thành',
            'CANCELLED': 'Đã hủy'
        };
        return texts[status] || status;
    }

    function renderPagination(containerId, totalPages, currentPage, loadFunction) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!totalPages || totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = '';

        const prevBtn = document.createElement('button');
        prevBtn.textContent = '← Trước';
        prevBtn.disabled = currentPage === 0;
        if (currentPage > 0) prevBtn.addEventListener('click', () => loadFunction(currentPage - 1));
        container.appendChild(prevBtn);

        const start = Math.max(0, currentPage - 2);
        const end = Math.min(totalPages, currentPage + 3);

        for (let i = start; i < end; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i + 1;
            if (i === currentPage) pageBtn.className = 'active';
            pageBtn.addEventListener('click', () => loadFunction(i));
            container.appendChild(pageBtn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Sau →';
        nextBtn.disabled = currentPage >= totalPages - 1;
        if (currentPage < totalPages - 1) nextBtn.addEventListener('click', () => loadFunction(currentPage + 1));
        container.appendChild(nextBtn);
    }

    function showError(elementId, message) {
        const errorDiv = document.getElementById(elementId);
        if (!errorDiv) return;
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // User management functions
    function openUpdateRole(userId, username, currentRole) {
        selectedUserId = userId;
        const nameEl = document.getElementById('role-username');
        const roleEl = document.getElementById('role-select');
        if (nameEl) nameEl.value = username;
        // currentRole comes as "ROLE_ADMIN" or "ROLE_CUSTOMER", use it directly
        if (roleEl) {
            roleEl.value = currentRole;
            // Disable customer option if current role is admin (to prevent demotion)
            const customerOption = roleEl.querySelector('option[value="ROLE_CUSTOMER"]');
            if (customerOption) {
                if (currentRole === 'ROLE_ADMIN') {
                    customerOption.disabled = true;
                    customerOption.textContent = 'CUSTOMER (không thể hạ cấp từ admin)';
                } else {
                    customerOption.disabled = false;
                    customerOption.textContent = 'CUSTOMER';
                }
            }
        }
        openModal('role-modal');
    }

    async function updateRole() {
        const newRoleEl = document.getElementById('role-select');
        const newRole = newRoleEl ? newRoleEl.value : null;
        if (newRole === null) {
            alert('Chưa chọn vai trò mới');
            return;
        }
        try {
            const response = await fetch('/admin/users/role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: selectedUserId,
                    newRoleName: newRole
                })
            });

            if (response.ok) {
                closeModal('role-modal');
                loadUsers(currentUsersPage);
                alert('Cập nhật vai trò thành công!');
            } else {
                const errorText = await response.text();
                alert('Lỗi: ' + errorText);
            }
        } catch (error) {
            console.error('Error updating role:', error);
            alert('Lỗi: Không thể cập nhật vai trò');
        }
    }

    function openAddUser() {
        const usernameEl = document.getElementById('add-username');
        const passwordEl = document.getElementById('add-password');
        const emailEl = document.getElementById('add-email');
        const roleEl = document.getElementById('add-role');

        if (usernameEl) usernameEl.value = '';
        if (passwordEl) passwordEl.value = '';
        if (emailEl) emailEl.value = '';
        if (roleEl) roleEl.value = 'ROLE_CUSTOMER';

        openModal('add-user-modal');
    }

    async function addUser() {
        const usernameEl = document.getElementById('add-username');
        const passwordEl = document.getElementById('add-password');
        const emailEl = document.getElementById('add-email');
        const roleEl = document.getElementById('add-role');

        const username = usernameEl ? usernameEl.value.trim() : '';
        const password = passwordEl ? passwordEl.value : '';
        const email = emailEl ? emailEl.value.trim() : '';
        const roleName = roleEl ? roleEl.value : 'ROLE_CUSTOMER';

        // Validation
        if (!username) {
            alert('Vui lòng nhập tên đăng nhập');
            if (usernameEl) usernameEl.focus();
            return;
        }

        if (username.length < 3) {
            alert('Tên đăng nhập phải có ít nhất 3 ký tự');
            if (usernameEl) usernameEl.focus();
            return;
        }

        if (!password) {
            alert('Vui lòng nhập mật khẩu');
            if (passwordEl) passwordEl.focus();
            return;
        }

        if (password.length < 6) {
            alert('Mật khẩu phải có ít nhất 6 ký tự');
            if (passwordEl) passwordEl.focus();
            return;
        }

        if (!email) {
            alert('Vui lòng nhập email');
            if (emailEl) emailEl.focus();
            return;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Email không hợp lệ');
            if (emailEl) emailEl.focus();
            return;
        }

        try {
            const response = await fetch('/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    email: email,
                    roleName: roleName
                })
            });

            if (response.ok) {
                closeModal('add-user-modal');
                loadUsers(currentUsersPage);
                alert('Thêm người dùng thành công!');
            } else {
                const errorText = await response.text();
                alert('Lỗi: ' + errorText);
            }
        } catch (error) {
            console.error('Error adding user:', error);
            alert('Lỗi kết nối: ' + error.message + '\nVui lòng kiểm tra kết nối mạng và thử lại.');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Bạn có chắc muốn xóa người dùng này? Hành động này không thể hoàn tác.')) return;

        try {
            const response = await fetch(`/admin/users/${userId}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                loadUsers(currentUsersPage);
                alert('Xóa người dùng thành công!');
            } else {
                const errorText = await response.text();
                alert('Lỗi: ' + errorText);
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Lỗi: Không thể xóa người dùng');
        }
    }

    // Order management functions
    async function viewOrderDetails(orderId) {
        openModal('order-modal');
        const detailsDiv = document.getElementById('order-details');
        if (detailsDiv) detailsDiv.innerHTML = '<div class="loading">Đang tải...</div>';
        try {
            const response = await fetch(`/admin/orders/${orderId}`);
            if (!response.ok) throw new Error('Failed to load order details');
            const order = await response.json();

            if (!detailsDiv) return;
            detailsDiv.innerHTML = '';

            const fields = [
                { label: 'Mã đơn hàng:', value: order.orderId },
                { label: 'Người dùng:', value: order.username },
                { label: 'Sản phẩm:', value: order.productName },
                { label: 'Ngày thanh toán:', value: order.paidDate || 'Chưa thanh toán' }
            ];

            fields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'form-group';
                const label = document.createElement('label');
                label.textContent = field.label;
                const value = document.createElement('div');
                value.textContent = field.value;
                group.appendChild(label);
                group.appendChild(value);
                detailsDiv.appendChild(group);
            });

            const statusGroup = document.createElement('div');
            statusGroup.className = 'form-group';
            const statusLabel = document.createElement('label');
            statusLabel.textContent = 'Trạng thái:';
            const statusValue = document.createElement('div');
            statusValue.innerHTML = `<span class="badge ${getStatusBadge(order.status)}">${getStatusText(order.status)}</span>`;
            statusGroup.appendChild(statusLabel);
            statusGroup.appendChild(statusValue);
            detailsDiv.appendChild(statusGroup);

            if (order.license) {
                const licenseGroup = document.createElement('div');
                licenseGroup.className = 'form-group';
                const licenseLabel = document.createElement('label');
                licenseLabel.textContent = 'Giấy phép:';
                const licenseValue = document.createElement('div');

                const keyDiv = document.createElement('div');
                const keyStrong = document.createElement('strong');
                keyStrong.textContent = 'Key: ';
                const keyCode = document.createElement('code');
                keyCode.textContent = order.license.licenseKey;
                keyDiv.appendChild(keyStrong);
                keyDiv.appendChild(keyCode);

                const statusDiv = document.createElement('div');
                const statusStrong = document.createElement('strong');
                statusStrong.textContent = 'Trạng thái: ';
                statusDiv.appendChild(statusStrong);
                statusDiv.innerHTML += `<span class="badge ${order.license.enabled ? 'badge-success' : 'badge-danger'}">
                ${order.license.enabled ? 'Hoạt động' : 'Bị thu hồi'}
            </span>`;

                licenseValue.appendChild(keyDiv);
                licenseValue.appendChild(statusDiv);
                licenseGroup.appendChild(licenseLabel);
                licenseGroup.appendChild(licenseValue);
                detailsDiv.appendChild(licenseGroup);
            } else {
                const noLicenseGroup = document.createElement('div');
                noLicenseGroup.className = 'form-group';
                const em = document.createElement('em');
                em.textContent = 'Chưa có giấy phép';
                noLicenseGroup.appendChild(em);
                detailsDiv.appendChild(noLicenseGroup);
            }
        } catch (error) {
            console.error('Error loading order details:', error);
            const dd = document.getElementById('order-details');
            if (dd) dd.innerHTML = '<div class="error">Không thể tải chi tiết đơn hàng</div>';
        }
    }

    // License management functions
    function openRevoke(licenseKey) {
        selectedLicenseKey = licenseKey;
        const keyEl = document.getElementById('revoke-key');
        const reasonEl = document.getElementById('revoke-reason');
        if (keyEl) keyEl.value = licenseKey;
        if (reasonEl) reasonEl.value = '';
        openModal('revoke-modal');
    }

    async function revokeLicense() {
        const reasonEl = document.getElementById('revoke-reason');
        const reason = reasonEl ? reasonEl.value : '';
        if (!reason.trim()) {
            alert('Vui lòng nhập lý do thu hồi');
            return;
        }
        try {
            const response = await fetch('/admin/licenses/revoke', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    licenseKey: selectedLicenseKey,
                    reason: reason
                })
            });

            if (response.ok) {
                closeModal('revoke-modal');
                const searchKeyEl = document.getElementById('license-search');
                const currentSearch = searchKeyEl ? searchKeyEl.value : '';
                loadLicenses(currentLicensesPage, currentSearch);
                alert('Thu hồi giấy phép thành công!');
            } else {
                alert('Lỗi: Không thể thu hồi giấy phép');
            }
        } catch (error) {
            console.error('Error revoking license:', error);
            alert('Lỗi: Không thể thu hồi giấy phép');
        }
    }

    async function resetDevice(licenseKey) {
        if (!confirm('Bạn có chắc muốn reset thiết bị cho giấy phép này?')) return;
        try {
            const response = await fetch('/admin/licenses/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ licenseKey })
            });

            if (response.ok) {
                alert('Reset thiết bị thành công!');
            } else {
                alert('Lỗi: Không thể reset thiết bị');
            }
        } catch (error) {
            console.error('Error resetting device:', error);
            alert('Lỗi: Không thể reset thiết bị');
        }
    }

    // Product management functions
    let selectedProductId = null;

    async function loadProducts() {
        try {
            const response = await fetch('/admin/products');
            if (!response.ok) throw new Error('Failed to load products');
            const products = await response.json();

            const tbody = document.getElementById('products-table');
            if (!tbody) return;

            if (!Array.isArray(products) || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Không có dữ liệu</td></tr>';
            } else {
                tbody.innerHTML = products.map(product => {
                    const escapedName = escapeHtml(product.productName);
                    const escapedDesc = escapeHtml(product.description || '');
                    const escapedImg = escapeHtml(product.imageUrl || '');
                    return `
                <tr>
                    <td>${product.productId}</td>
                    <td>${escapedName}</td>
                    <td>${formatCurrency(product.price)}</td>
                    <td>${product.quantity}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick='openEditProduct(${product.productId}, ${JSON.stringify(escapedName)}, ${JSON.stringify(escapedDesc)}, ${product.price}, ${product.quantity}, ${JSON.stringify(escapedImg)})'>
                            Sửa
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.productId})">
                            Xóa
                        </button>
                    </td>
                </tr>
            `}).join('');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            showError('products-error', 'Không thể tải dữ liệu sản phẩm');
        }
    }

    function openAddProduct() {
        selectedProductId = null;
        const titleEl = document.getElementById('product-modal-title');
        const nameEl = document.getElementById('product-name');
        const descEl = document.getElementById('product-description');
        const priceEl = document.getElementById('product-price');
        const qtyEl = document.getElementById('product-quantity');
        const imgEl = document.getElementById('product-image-url');
        const previewContainer = document.getElementById('image-preview-container');

        if (titleEl) titleEl.textContent = 'Thêm sản phẩm';
        if (nameEl) nameEl.value = '';
        if (descEl) descEl.value = '';
        if (priceEl) priceEl.value = '';
        if (qtyEl) qtyEl.value = '';
        if (imgEl) imgEl.value = '';
        if (previewContainer) previewContainer.style.display = 'none';

        openModal('product-modal');
    }

    function openEditProduct(id, name, description, price, quantity, imageUrl) {
        selectedProductId = id;
        const titleEl = document.getElementById('product-modal-title');
        const nameEl = document.getElementById('product-name');
        const descEl = document.getElementById('product-description');
        const priceEl = document.getElementById('product-price');
        const qtyEl = document.getElementById('product-quantity');
        const imgEl = document.getElementById('product-image-url');

        if (titleEl) titleEl.textContent = 'Sửa sản phẩm';
        if (nameEl) nameEl.value = name;
        if (descEl) descEl.value = description;
        if (priceEl) priceEl.value = price;
        if (qtyEl) qtyEl.value = quantity;
        if (imgEl) imgEl.value = imageUrl;

        // Trigger image preview for existing URL
        previewProductImage();

        openModal('product-modal');
    }

    async function saveProduct() {
        const nameEl = document.getElementById('product-name');
        const descEl = document.getElementById('product-description');
        const priceEl = document.getElementById('product-price');
        const qtyEl = document.getElementById('product-quantity');
        const imgEl = document.getElementById('product-image-url');

        const name = nameEl ? nameEl.value : '';
        const description = descEl ? descEl.value : '';
        const price = priceEl ? parseFloat(priceEl.value) : 0;
        const quantity = qtyEl ? parseInt(qtyEl.value) : 0;
        const imageUrl = imgEl ? imgEl.value : '';

        if (!name.trim()) {
            alert('Vui lòng nhập tên sản phẩm');
            return;
        }

        if (price <= 0) {
            alert('Vui lòng nhập giá hợp lệ');
            return;
        }

        if (quantity < 0) {
            alert('Vui lòng nhập số lượng hợp lệ');
            return;
        }

        try {
            const productData = {
                productName: name,
                description: description,
                price: price,
                quantity: quantity,
                imageUrl: imageUrl
            };

            let url = '/admin/products';
            if (selectedProductId) {
                url = `/admin/products/${selectedProductId}`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            });

            if (response.ok) {
                closeModal('product-modal');
                loadProducts();
                alert(selectedProductId ? 'Cập nhật sản phẩm thành công!' : 'Thêm sản phẩm thành công!');
            } else {
                alert('Lỗi: Không thể lưu sản phẩm');
            }
        } catch (error) {
            console.error('Error saving product:', error);
            alert('Lỗi: Không thể lưu sản phẩm');
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

        try {
            const response = await fetch(`/admin/products/${id}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                loadProducts();
                alert('Xóa sản phẩm thành công!');
            } else {
                alert('Lỗi: Không thể xóa sản phẩm');
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            alert('Lỗi: Không thể xóa sản phẩm');
        }
    }

    // Image preview functions
    let imagePreviewTimeout = null;
    const IMAGE_PREVIEW_DEBOUNCE_MS = 500; // Debounce delay for image preview loading

    function previewProductImage() {
        const imgUrlEl = document.getElementById('product-image-url');
        const previewContainer = document.getElementById('image-preview-container');
        const previewImg = document.getElementById('product-image-preview');
        const errorMsg = document.getElementById('image-error-message');
        const loadingMsg = document.getElementById('image-loading-message');

        if (!imgUrlEl || !previewContainer || !previewImg) return;

        const url = imgUrlEl.value.trim();

        // Clear previous timeout
        if (imagePreviewTimeout) {
            clearTimeout(imagePreviewTimeout);
        }

        // Hide preview if URL is empty
        if (!url) {
            previewContainer.style.display = 'none';
            previewImg.style.display = 'none';
            if (errorMsg) errorMsg.style.display = 'none';
            if (loadingMsg) loadingMsg.style.display = 'none';
            return;
        }

        // Validate URL format
        const urlPattern = /^https?:\/\/.+/i;
        if (!urlPattern.test(url)) {
            previewContainer.style.display = 'block';
            if (loadingMsg) loadingMsg.style.display = 'none';
            if (errorMsg) errorMsg.style.display = 'block';
            previewImg.style.display = 'none';
            return;
        }

        // Validate image file extension
        const imageExtensions = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i;
        const hasImageExtension = imageExtensions.test(url);

        // Show preview container and loading message
        previewContainer.style.display = 'block';
        if (loadingMsg) loadingMsg.style.display = 'block';
        if (errorMsg) errorMsg.style.display = 'none';
        previewImg.style.display = 'none';

        // Debounce the image loading
        imagePreviewTimeout = setTimeout(() => {
            // Show a warning if the URL doesn't have a recognized image extension
            if (!hasImageExtension && loadingMsg) {
                loadingMsg.innerHTML = '⚠️ URL không có phần mở rộng hình ảnh thông thường. Đang thử tải...';
            }
            previewImg.src = url;
        }, IMAGE_PREVIEW_DEBOUNCE_MS);
    }

    function hideImageMessages() {
        const errorMsg = document.getElementById('image-error-message');
        const loadingMsg = document.getElementById('image-loading-message');
        if (errorMsg) errorMsg.style.display = 'none';
        if (loadingMsg) loadingMsg.style.display = 'none';
    }

    function showImageError() {
        const previewImg = document.getElementById('product-image-preview');
        const errorMsg = document.getElementById('image-error-message');
        const loadingMsg = document.getElementById('image-loading-message');

        if (previewImg) previewImg.style.display = 'none';
        if (loadingMsg) loadingMsg.style.display = 'none';
        if (errorMsg) errorMsg.style.display = 'block';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Bind nav buttons (data-tab support). Keep compatibility with inline onclick.
        document.querySelectorAll('.nav-tabs .nav-tab').forEach(btn => {
            // ensure data-tab exists (extract from existing onclick if needed)
            if (!btn.dataset.tab) {
                const onclick = btn.getAttribute('onclick');
                if (onclick) {
                    const m = onclick.match(/'([^']+)'/);
                    if (m && m[1]) btn.dataset.tab = m[1];
                }
            }

            btn.addEventListener('click', function (e) {
                const tab = btn.dataset.tab;
                if (tab) switchTab(tab, e);
                else {
                    // fallback: try to read inner text mapping
                    const text = (btn.textContent || '').toLowerCase();
                    if (text.indexOf('tổng quan') !== -1) switchTab('dashboard', e);
                    else if (text.indexOf('người dùng') !== -1) switchTab('users', e);
                    else if (text.indexOf('đơn hàng') !== -1) switchTab('orders', e);
                    else if (text.indexOf('giấy phép') !== -1) switchTab('licenses', e);
                    else if (text.indexOf('sản phẩm') !== -1) switchTab('products', e);
                }
            });
        });

        // Bind filters and search if present
        const statusFilter = document.getElementById('order-status-filter');
        if (statusFilter) statusFilter.addEventListener('change', () => loadOrders(0));
        const dateFilter = document.getElementById('order-date-filter');
        if (dateFilter) dateFilter.addEventListener('change', () => loadOrders(0));
        const licenseSearch = document.getElementById('license-search');
        if (licenseSearch) licenseSearch.addEventListener('keyup', searchLicenses);

        // Determine initial tab:
        let initialTab = 'dashboard';
        const hash = (location.hash || '').replace('#', '').trim();
        if (hash) initialTab = hash;
        else {
            try {
                const saved = localStorage.getItem('activeAdminTab');
                if (saved) initialTab = saved;
            } catch (e) {
                // ignore
            }
        }

        // If server pre-rendered an active tab (button has .active), prefer that if no hash/localStorage
        if (!hash) {
            const serverActiveBtn = document.querySelector('.nav-tab.active');
            if (serverActiveBtn && serverActiveBtn.dataset && serverActiveBtn.dataset.tab) {
                initialTab = serverActiveBtn.dataset.tab;
            }
        }

        // Activate initial tab (switchTab handles loading data)
        switchTab(initialTab);

        // React to manual hash changes
        window.addEventListener('hashchange', () => {
            const newHash = (location.hash || '').replace('#', '').trim();
            if (newHash) switchTab(newHash);
        });

        // Redraw chart on resize when dashboard active
        let resizeTimeout = null;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const dashboardActive = document.getElementById('dashboard-tab') && document.getElementById('dashboard-tab').classList.contains('active');
                if (!dashboardActive) return;
                // reload revenue data and redraw
                fetch('/admin/stats/revenue-chart')
                    .then(r => r.ok ? r.json() : Promise.reject('no data'))
                    .then(data => {
                        const canvas = document.getElementById('revenue-chart');
                        if (!canvas) return;
                        const ctx = canvas.getContext('2d');
                        canvas.width = canvas.parentElement.clientWidth || 600;
                        canvas.height = 300;
                        if (Array.isArray(data) && data.length > 0) drawSimpleChart(ctx, data, canvas.width, canvas.height);
                        else {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.font = '16px Arial';
                            ctx.fillStyle = '#666';
                            ctx.textAlign = 'center';
                            ctx.fillText('Chưa có dữ liệu doanh thu', canvas.width / 2, canvas.height / 2);
                        }
                    }).catch(() => {});
            }, 200);
        });
    });
</script>